include:
  - project: 'kevineu/devex/ci-cd-pipelines'
    file: '/gitlab-utils/.gitlab-ci-globals.yml'
  - project: 'kevineu/appsec/sast-configs'
    file: '/Semgrep.gitlab-ci.yml'
  - project: 'kevineu/devex/ci-cd-pipelines'
    file: '/gitlab-utils/.gitlab-ci-build-push.yml'
    ref: 'no-create-workspace-dir'

.rules:
  - &on-merge-request
    if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  - &on-push-to-main
    if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"

.deploy_trigger:
  trigger:
    include:
      - local: .gitlab-ci-deploy.yml

.dev_trigger:
  extends: .deploy_trigger
  stage: deploy_dev

variables:
  APP_NAME: db-operator
  KUBERNETES_CPU_REQUEST: "1"
  KUBERNETES_CPU_LIMIT: "4"
  KUBERNETES_MEMORY_REQUEST: "2Gi"
  KUBERNETES_MEMORY_LIMIT: "4Gi"

test image:
  services:
  - docker:20.10.16-dind
  stage: test
  tags: [ "k8s-runner" ]
  image:
    name: golang:1.20-buster
    pull_policy: if-not-present
  before_script:
  # these would trigger the test to try with AWS credentials
    - unset AWS_ROLE_ARN
    - unset AWS_REGION
  script:
    - apt-get update && apt-get install -y ca-certificates curl gnupg lsb-release
    - mkdir -m 0755 -p /etc/apt/keyrings && curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
    - apt-get update && apt-get install -y docker-ce-cli
    - make kuttl-test
    - go test ./... -v -short
  rules:
    - *on-merge-request
    - *on-push-to-main